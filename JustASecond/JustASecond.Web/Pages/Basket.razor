@page "/basket/{OrderId:int}/{TableId:int}/{CustomerName}/{CustomerId:int}"
@using JustASecond.DAL.Interfaces
@inject IUnitOfWork unitOfWork
@inject NavigationManager navigationManager

<link rel="stylesheet" href="/css/basket.css" />

@if (Orderpositions != null && _order.Sent == false)
{
    <div class="page-container">
        <button class="btn-go-back"><i class="fa fa-arrow-left" aria-hidden="true"></i></button>
        <div class="top-container">
            <h3>Cart</h3>
        </div>
        <div class="content-container">
            @foreach (var item in Orderpositions)
            {
                @if (@item.Product != null)
                {
                    <div class="item-container">
                        <img src="/images/food/@item.Product.Image" />
                        <div class="description">
                            <p>@item.Product.Title</p>
                        </div>
                        <div class="price">
                            <h4>@item.Product.Price</h4>
                        </div>
                        <div class="amount-change">
                            <button class="btn-change" @onclick="async () => await LowerOrderPositionAmount(item.OrderId, item.Position, item.Amount)">-</button>
                            <input type="number" @bind-value="item.Amount" />
                            <button class="btn-change" @onclick="async () => await RaiseOrderPositionAmount(item.OrderId, item.Position, item.Amount)">+</button>
                        </div>
                    </div>
                }
            }
        </div>
        <div class="divider"></div>
        <div class="footer-container">
            <div class="total">
                <p>Total</p>
                <p>@total</p>
            </div>
            <button @onclick="PlaceOrder" class="btn-place-order">Place order</button>
        </div>
    </div>
}

@code {
    [Parameter]
    public int OrderId { get; set; }
    [Parameter]
    public int TableId { get; set; }
    [Parameter]
    public int CustomerId { get; set; }
    [Parameter]
    public string CustomerName { get; set; }

    private Order _order;
    private List<OrderPosition> Orderpositions;
    private decimal total;

    protected async override Task OnInitializedAsync()
    {
        _order = await unitOfWork.OrderRepo.GetOrder(OrderId);
        Orderpositions = await unitOfWork.OrderRepo.GetOrderPositionsFromOrder(_order);

        total = CalcTotal();
    }

    private async Task RaiseOrderPositionAmount(int orderId, int position, int amount)
    {
        await unitOfWork.OrderRepo.SetOrderPositionAmount(orderId, position, amount + 1);
        total = CalcTotal();
        await unitOfWork.SaveChanges();
    }

    private async Task LowerOrderPositionAmount(int orderId, int position, int amount)
    {
        if (amount <= 1)
        {
            await unitOfWork.OrderRepo.RemoveOrderPosition(orderId, position);
            await unitOfWork.SaveChanges();
        }
        else
        {
            await unitOfWork.OrderRepo.SetOrderPositionAmount(orderId, position, amount - 1);
            await unitOfWork.SaveChanges();
        }
        Orderpositions = await unitOfWork.OrderRepo.GetOrderPositionsFromOrder(_order);
        total = CalcTotal();
    }

    private decimal CalcTotal()
    {
        total = 0;
        foreach (var item in Orderpositions)
        {
            total += (item.Product.Price * item.Amount);
        }
        return total;
    }

    public async void PlaceOrder()
    {
        await unitOfWork.OrderRepo.SetOrderSent(_order.Id, true);
        await unitOfWork.SaveChanges();
        navigationManager.NavigateTo($"/confirmation/{TableId}/{CustomerName}/{CustomerId}");
    }
}
